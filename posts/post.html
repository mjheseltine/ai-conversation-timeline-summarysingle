<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversation</title>

<style>
:root {
  --bg:#f6f7fb;
  --card:#fff;
  --muted:#6b7280;
  --accent:#1f6feb;
  --radius:12px;
  --shadow:0 4px 12px rgba(35,40,50,0.08);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;
}

body { background:var(--bg); margin:20px; }
.container { max-width:800px; margin:auto; }

.top-nav {
  position: sticky;
  top: 12px;
  z-index: 50;
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.home-btn {
  text-decoration:none;
  font-weight:600;
  color:#1f6feb;
  background:#eef2ff;
  padding:8px 14px;
  border-radius:20px;
}

.post {
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--shadow);
  display:flex;
  gap:12px;
  margin-bottom:16px;
}

.avatar {
  width:48px;
  height:48px;
  border-radius:50%;
  display:grid;
  place-items:center;
  color:#fff;
  font-weight:700;
}

.content { flex:1; }

.meta { font-size:13px; color:var(--muted); }
.name { font-weight:700; margin-right:6px; }

.text {
  margin-top:6px;
  font-size:15px;
  line-height:1.45;
}

.thumb {
  width:100%;
  border-radius:10px;
  margin-top:10px;
}

.actions {
  margin-top:12px;
  display:flex;
  gap:20px;
  color:var(--muted);
}

.actions button {
  -webkit-appearance: none;
  appearance: none;
  background: none;
  border: none;
  cursor: pointer;

  display: inline-flex;
  align-items: center;
  gap: 6px;

  padding: 6px 8px;
  border-radius: 8px;

  font-size: 14px;
  line-height: 1;
  font-weight: 600;

  font-family: Inter,system-ui,-apple-system,"Segoe UI",Roboto,
               "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji";
}

.actions button:hover { background:#f1f5f9; }

.actions button span {
  font-variant-numeric: tabular-nums;
  line-height: 1;
}

.liked { color:#e0245e; }
.retweeted { color:#17bf63; }

/* USER COMMENT HIGHLIGHT */
.user-comment {
  background:#f0f7ff;
  border:1px solid #dbeafe;
}

/* AI IN-THREAD STYLES */
.ai-request {
  background:#f8fafc;
  border:1px solid #e5e7eb;
}

.ai-response {
  background: #fff7cc;        /* warmer, more noticeable gold */
  border: 1px solid #f5c97a;  /* stronger gold border */
}

/* SHOW MORE */
.show-more-wrap {
  display:flex;
  justify-content:center;
  margin: 6px 0 18px;
}

.show-more-btn {
  background: #eef2ff;
  color: #1f6feb;
  border: 1px solid #c7d2fe;
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
}
.show-more-btn:hover { background:#e0e7ff; }

/* COMMENT BOX */
.comment-box {
  margin: 18px 0 16px;
}

.comment-box textarea {
  width:100%;
  min-height:80px;
  border-radius:8px;
  border:1px solid #d1d5db;
  padding:8px;
  font-size:14px;
}

.comment-box button {
  margin-top:6px;
  background:var(--accent);
  color:white;
  border:none;
  padding:7px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

.bottom-nav {
  display:flex;
  justify-content:center;
  margin:40px 0 60px;
}
</style>
</head>

<body>

<div class="container">

  <!-- TOP NAV -->
  <div class="top-nav">
    <a class="home-btn" href="../index.html">‚Üê Return to timeline</a>
  </div>

  <!-- MAIN POST -->
  <div id="thread"></div>

  <!-- COMMENTS / REPLIES (includes AI in-thread items too) -->
  <div id="comments"></div>

  <!-- SHOW MORE BUTTON AREA -->
  <div class="show-more-wrap" id="showMoreWrap" style="display:none;">
    <button class="show-more-btn" id="showMoreBtn">Show more comments</button>
  </div>

  <!-- REPLY BOX (BOTTOM, ABOVE NAV) -->
  <div id="replyBoxMount"></div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <a class="home-btn" href="../index.html">‚Üê Return to timeline</a>
  </div>

</div>

<script>
// ---------- Helpers ----------
function initials(name) {
  return name.split(/\s+/).map(w => w[0]).join("").slice(0,2).toUpperCase();
}

function colorFromName(name) {
  const colors = [
    "linear-gradient(135deg,#1f6feb,#3b82f6)",
    "linear-gradient(135deg,#10b981,#34d399)",
    "linear-gradient(135deg,#f59e0b,#fbbf24)",
    "linear-gradient(135deg,#ec4899,#f472b6)",
    "linear-gradient(135deg,#6366f1,#8b5cf6)"
  ];
  return colors[name.charCodeAt(0) % colors.length];
}

// ---------- Load ID + State ----------
const postId = new URLSearchParams(location.search).get("id");

let timelineState = JSON.parse(sessionStorage.getItem("timelineState") || "{}");

const state = (timelineState[postId] ||= {
  likes:0,
  retweets:0,
  comments:[],
  liked:false,
  retweeted:false
});

function save() {
  timelineState[postId] = state;
  sessionStorage.setItem("timelineState", JSON.stringify(timelineState));
}

const thread = document.getElementById("thread");
const comments = document.getElementById("comments");
const showMoreWrap = document.getElementById("showMoreWrap");
const showMoreBtn = document.getElementById("showMoreBtn");
const replyBoxMount = document.getElementById("replyBoxMount");

// ---------- Timing ----------
const convoStart = Date.now();

// ---------- Config ----------
const INITIAL_VISIBLE_REPLIES = 5;
let hiddenReplyEls = [];

// ---------- Load Post ----------
fetch("../data/posts.json")
  .then(r => r.json())
  .then(posts => {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    if (!state.initialized) {
      state.likes = post.likes || 0;
      state.retweets = post.retweets || 0;
      state.initialized = true;
      save();
    }

    renderMainPost(post);

    // ‚úÖ AI is rendered as an in-thread exchange (request + response)
    // If you want to gate by condition, wrap this call in your treatment check.
    renderAIInThread(post);

    // Replies: first 5 visible, rest hidden behind Show more
    renderRepliesWithShowMore(post.replies || []);

    // User comments always visible after replies
    renderUserComments();

    // Reply box at the very bottom
    renderCommentBox();
  });

// ---------- Render Main ----------
function renderMainPost(p) {
  const el = document.createElement("article");
  el.className = "post";

  el.innerHTML = `
    <div class="avatar" style="background:${colorFromName(p.author)}">
      ${initials(p.author)}
    </div>
    <div class="content">
      <div class="meta">
        <span class="name">${p.author}</span>
        ${p.handle} ¬∑ ${p.timestamp}
      </div>
      <div class="text">${p.text}</div>
      ${p.image ? `<img src="../${p.image}" class="thumb">` : ""}
      <div class="actions">
        <button class="like ${state.liked ? "liked":""}">‚ù§Ô∏è <span>${state.likes}</span></button>
        <button class="retweet ${state.retweeted ? "retweeted":""}">üîÅ <span>${state.retweets}</span></button>
      </div>
    </div>
  `;

  thread.appendChild(el);

  el.querySelector(".like").onclick = () => {
    state.liked = !state.liked;
    state.likes += state.liked ? 1 : -1;
    el.querySelector(".like").classList.toggle("liked", state.liked);
    el.querySelector(".like span").textContent = state.likes;
    save();

    window.parent.postMessage({ type:"USER_LIKE", postId, count:state.likes }, "*");
  };

  el.querySelector(".retweet").onclick = () => {
    state.retweeted = !state.retweeted;
    state.retweets += state.retweeted ? 1 : -1;
    el.querySelector(".retweet").classList.toggle("retweeted", state.retweeted);
    el.querySelector(".retweet span").textContent = state.retweets;
    save();

    window.parent.postMessage({ type:"USER_RETWEET", postId, count:state.retweets }, "*");
  };
}

// ---------- AI as in-thread exchange (randomized but stable per post per session) ----------
function renderAIInThread(p) {
  if (!p.aiSummary) return;

  const promptPool = [
    "@AI, can you add context on this?",
    "@AI, what's the key takeaway here?",
    "@AI, summarize what happened and why it matters?",
    "@AI, what are people arguing about in this story?",
    "@AI, is there anything important I'm missing?",
    "@AI, break this down in plain English?"
  ];

  const userPool = [
    { name: "Jordan Miles", handle: "@jordanmiles" },
    { name: "Casey Nguyen", handle: "@caseynguyen" },
    { name: "Ava Thompson", handle: "@avathompson" },
    { name: "Sam Patel", handle: "@sampatel" },
    { name: "Riley Chen", handle: "@rileychen" },
    { name: "Morgan Lee", handle: "@morganlee" }
  ];

  // Stable per post per session (so reloads don't change it)
  const key = `aiThreadVariant_${postId}`;
  let picked = null;

  try {
    picked = JSON.parse(sessionStorage.getItem(key) || "null");
  } catch (e) {}

  if (!picked) {
    picked = {
      promptIdx: Math.floor(Math.random() * promptPool.length),
      userIdx: Math.floor(Math.random() * userPool.length)
    };
    sessionStorage.setItem(key, JSON.stringify(picked));
  }

  const promptText = promptPool[picked.promptIdx];
  const u = userPool[picked.userIdx];

  // 1) "User" request post
  const req = document.createElement("article");
  req.className = "post ai-request";
  req.innerHTML = `
    <div class="avatar" style="background:${colorFromName(u.name)}">
      ${initials(u.name)}
    </div>
    <div class="content">
      <div class="meta">
        <span class="name">${u.name}</span> ${u.handle} ¬∑ 1m
      </div>
      <div class="text">${promptText}</div>
    </div>
  `;
  comments.appendChild(req);

  // 2) AI response post (the summary)
  const res = document.createElement("article");
  res.className = "post ai-response";
  res.innerHTML = `
    <div class="avatar" style="background:linear-gradient(135deg,#111827,#374151)">ü§ñ</div>
    <div class="content">
      <div class="meta">
        <span class="name">AI</span> @ai_assistant ¬∑ 1m
      </div>
      <div class="text">${p.aiSummary}</div>
    </div>
  `;
  comments.appendChild(res);
}

// ---------- Replies with Show More ----------
function renderRepliesWithShowMore(replies) {
  hiddenReplyEls = [];

  replies.forEach((r, idx) => {
    const el = renderReply(r);

    if (idx >= INITIAL_VISIBLE_REPLIES) {
      el.style.display = "none";
      hiddenReplyEls.push(el);
    }

    comments.appendChild(el);
  });

  if (hiddenReplyEls.length > 0) {
    showMoreWrap.style.display = "flex";
    showMoreBtn.textContent = `Show more comments (${hiddenReplyEls.length})`;
    showMoreBtn.onclick = () => {
      const revealedCount = hiddenReplyEls.length;

      hiddenReplyEls.forEach(e => (e.style.display = ""));
      hiddenReplyEls = [];
      showMoreWrap.style.display = "none";

      // ‚úÖ Qualtrics tracking
      window.parent.postMessage({
        type: "SHOW_MORE_COMMENTS",
        postId,
        revealedCount
      }, "*");
    };
  } else {
    showMoreWrap.style.display = "none";
  }
}

// ---------- Render Reply ----------
function renderReply(r) {
  const el = document.createElement("article");
  el.className = "post";

  el.innerHTML = `
    <div class="avatar" style="background:${colorFromName(r.author)}">
      ${initials(r.author)}
    </div>
    <div class="content">
      <div class="meta">
        <span class="name">${r.author}</span> ${r.handle || ""}
      </div>
      <div class="text">${r.text}</div>
    </div>
  `;

  return el;
}

// ---------- User Comments ----------
function renderUserComments() {
  state.comments.forEach(c => {
    const el = document.createElement("article");
    el.className = "post user-comment";

    el.innerHTML = `
      <div class="avatar" style="background:#2563eb">YOU</div>
      <div class="content">
        <div class="name">You</div>
        <div class="text">${c}</div>
      </div>
    `;

    comments.appendChild(el);
  });
}

// ---------- Comment Box (bottom) ----------
function renderCommentBox() {
  const box = document.createElement("div");
  box.className = "comment-box";

  box.innerHTML = `
    <textarea id="userReply" placeholder="Write a reply..."></textarea>
    <button id="postReply">Reply</button>
  `;

  replyBoxMount.appendChild(box);

  box.querySelector("#postReply").onclick = () => {
    const ta = box.querySelector("#userReply");
    const txt = ta.value.trim();
    if (!txt) return;

    state.comments.push(txt);
    save();

    window.parent.postMessage({
      type:"USER_COMMENT",
      postId,
      text:txt
    }, "*");

    location.reload();
  };
}

// ---------- Scroll Depth ----------
window.addEventListener("scroll", () => {
  const depth = Math.round(
    (window.scrollY + window.innerHeight) /
    document.body.scrollHeight * 100
  );

  window.parent.postMessage({
    type:"SCROLL_DEPTH_CONVO",
    postId,
    depth
  }, "*");
});

// ---------- Time on Conversation ----------
window.addEventListener("beforeunload", () => {
  window.parent.postMessage({
    type:"TIME_ON_CONVO",
    postId,
    ms:Date.now() - convoStart
  }, "*");
});
</script>

</body>
</html>
