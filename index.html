<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timeline</title>

<style>
:root {
  --bg: #f6f7fb;
  --card: #fff;
  --muted: #6b7280;
  --accent: #1f6feb;
  --radius: 12px;
  --shadow: 0 4px 12px rgba(35, 40, 50, 0.08);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
}

body { background: var(--bg); margin: 20px; }

.layout {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 24px;
  max-width: 1100px;
  margin: auto;
}

.container { max-width: 800px; }

.post {
  background: var(--card);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 16px;
  display: flex;
  gap: 12px;
  box-shadow: var(--shadow);
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-weight: 700;
  color: #fff;
}

.content { flex: 1; }

.meta { font-size: 13px; color: var(--muted); }

.name { font-weight: 700; margin-right: 6px; }

.text { margin-top: 6px; font-size: 15px; line-height: 1.4; }

.thumb {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
}

.actions {
  margin-top: 12px;
  display: flex;
  gap: 20px;
  color: var(--muted);
}

.actions button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 6px;
}

.actions button:hover { background: #f1f5f9; }

.liked { color: #e0245e; }
.retweeted { color: #17bf63; }

.comment-box {
  margin-top: 10px;
  display: none;
}

.comment-box textarea {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  padding: 8px;
  font-size: 14px;
}

.comment-controls {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}

.comment-box button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}

.emoji-panel {
  display: none;
  margin-top: 6px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 6px;
  font-size: 20px;
}

.emoji-panel span { cursor: pointer; margin: 4px; }

.sidebar { position: sticky; top: 20px; }

.widget {
  background: var(--card);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}

.widget h3 { margin: 0 0 10px; font-size: 15px; }

.search-widget input {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
}

#trendingList li {
  list-style: none;
  padding: 6px 0;
  font-weight: 600;
  color: #1f6feb;
  cursor: pointer;
}

#trendingList li:hover { text-decoration: underline; }

/* AI SUMMARY (TIMELINE) */
.ai-summary {
  margin-top: 10px;
  padding: 10px;
  border-radius: 10px;
  background: #fffdf8;
  border: 1px solid #fbe5b3;
  font-size: 14px;
}

.ai-summary .label {
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 4px;
}

</style>
</head>

<body>

<div class="layout">
  <main class="container" id="timeline"></main>

  <aside class="sidebar">
    <div class="widget search-widget">
      <input id="searchInput" placeholder="Search posts">
    </div>

    <div class="widget">
      <h3>Trending</h3>
      <ul id="trendingList"></ul>
    </div>

    <div class="widget">
      <h3>Local Weather</h3>
      <div id="weather">Loadingâ€¦</div>
    </div>
  </aside>
</div>

<script>
// ---------- Helpers ----------
function initials(name) {
  return name.split(/\s+/).map(w => w[0]).join("").slice(0,2).toUpperCase();
}

function colorFromName(name) {
  const colors = [
    "linear-gradient(135deg,#1f6feb,#3b82f6)",
    "linear-gradient(135deg,#10b981,#34d399)",
    "linear-gradient(135deg,#f59e0b,#fbbf24)",
    "linear-gradient(135deg,#ec4899,#f472b6)",
    "linear-gradient(135deg,#6366f1,#8b5cf6)"
  ];
  return colors[name.charCodeAt(0) % colors.length];
}

// ---------- State ----------
let timelineState = JSON.parse(sessionStorage.getItem("timelineState") || "{}");
function save() {
  sessionStorage.setItem("timelineState", JSON.stringify(timelineState));
}

const timeline = document.getElementById("timeline");
let allPosts = [];

// ---------- Timing ----------
const timelineStart = Date.now();

// ---------- Load ----------
fetch("data/posts.json")
  .then(r => r.json())
  .then(posts => {
    allPosts = posts;
    renderTimeline(posts);
  });

function renderTimeline(posts) {
  timeline.innerHTML = "";
  posts.forEach(p => timeline.appendChild(createPost(p)));
}

// ---------- Create Post ----------
function createPost(data) {
  const state = timelineState[data.id] ||= {
    likes: data.likes || 0,
    retweets: data.retweets || 0,
    comments: [],
    liked: false,
    retweeted: false
  };

  const wrapper = document.createElement("article");
  wrapper.className = "post";

  wrapper.innerHTML = `
    <div class="avatar" style="background:${colorFromName(data.author)}">
      ${initials(data.author)}
    </div>

    <div class="content">
      <div class="meta">
        <span class="name">${data.author}</span>
        ${data.handle} Â· ${data.timestamp}
      </div>

     <div class="text">${data.text}</div>

${data.image ? `<img src="${data.image}" class="thumb">` : ""}

${data.aiSummary ? `
  <div class="ai-summary">
    <div class="label">AI Summary</div>
    <div>${data.aiSummary}</div>
  </div>
` : ""}


      <div class="actions">
        <button class="like ${state.liked ? "liked":""}">â¤ï¸ <span>${state.likes}</span></button>
        <button class="retweet ${state.retweeted ? "retweeted":""}">ğŸ” <span>${state.retweets}</span></button>
        <button class="comment">ğŸ’¬ <span>${data.replies.length + state.comments.length}</span></button>
      </div>

      <div class="comment-box">
        <textarea placeholder="Write a comment..."></textarea>

        <div class="comment-controls">
          <button class="emoji-toggle">ğŸ˜Š</button>
          <button class="submit">Reply</button>
        </div>

        <div class="emoji-panel">
          <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜Š</span><span>ğŸ˜</span>
          <span>ğŸ¤”</span><span>ğŸ˜¡</span><span>ğŸ˜¢</span><span>ğŸ‘</span>
          <span>ğŸ‘</span><span>ğŸ‰</span><span>â¤ï¸</span><span>ğŸ”¥</span>
        </div>
      </div>

      <a class="view-link" href="posts/post.html?id=${data.id}">View conversation â†’</a>
    </div>
  `;

  /* ---------- Qualtrics Hooks ---------- */

  wrapper.addEventListener("mouseenter", () => {
    window.parent.postMessage({ type: "USER_HOVER_POST", postId: data.id }, "*");
  });

  wrapper.querySelector(".view-link").onclick = () => {
    window.parent.postMessage({ type: "POST_OPEN", postId: data.id }, "*");
  };

  const likeBtn = wrapper.querySelector(".like");
  const rtBtn = wrapper.querySelector(".retweet");
  const commentBtn = wrapper.querySelector(".comment");
  const box = wrapper.querySelector(".comment-box");
  const ta = wrapper.querySelector("textarea");
  const submit = wrapper.querySelector(".submit");
  const emojiToggle = wrapper.querySelector(".emoji-toggle");
  const emojiPanel = wrapper.querySelector(".emoji-panel");

  likeBtn.onclick = () => {
    state.liked = !state.liked;
    state.likes += state.liked ? 1 : -1;
    likeBtn.classList.toggle("liked", state.liked);
    likeBtn.querySelector("span").textContent = state.likes;
    save();

    window.parent.postMessage({
      type: "USER_LIKE",
      postId: data.id,
      count: state.likes
    }, "*");
  };

  rtBtn.onclick = () => {
    state.retweeted = !state.retweeted;
    state.retweets += state.retweeted ? 1 : -1;
    rtBtn.classList.toggle("retweeted", state.retweeted);
    rtBtn.querySelector("span").textContent = state.retweets;
    save();

    window.parent.postMessage({
      type: "USER_RETWEET",
      postId: data.id,
      count: state.retweets
    }, "*");
  };

  commentBtn.onclick = () => {
    box.style.display = box.style.display === "block" ? "none" : "block";
    ta.focus();

    window.parent.postMessage({
      type: "COMMENT_BOX_OPEN",
      postId: data.id
    }, "*");
  };

  emojiToggle.onclick = () => {
    emojiPanel.style.display =
      emojiPanel.style.display === "block" ? "none" : "block";
  };

  emojiPanel.querySelectorAll("span").forEach(e => {
    e.onclick = () => {
      ta.value += e.textContent;
      ta.focus();
    };
  });

  submit.onclick = () => {
    const txt = ta.value.trim();
    if (!txt) return;

    state.comments.push(txt);
    ta.value = "";
    box.style.display = "none";
    commentBtn.querySelector("span").textContent =
      data.replies.length + state.comments.length;
    save();

    window.parent.postMessage({
      type: "USER_COMMENT",
      postId: data.id,
      text: txt
    }, "*");
  };

  return wrapper;
}

// ---------- Scroll Depth ----------
window.addEventListener("scroll", () => {
  const depth = Math.round(
    (window.scrollY + window.innerHeight) /
    document.body.scrollHeight * 100
  );

  window.parent.postMessage({
    type: "SCROLL_DEPTH",
    depth
  }, "*");
});

// ---------- Time on Timeline ----------
window.addEventListener("beforeunload", () => {
  window.parent.postMessage({
    type: "TIME_ON_TIMELINE",
    ms: Date.now() - timelineStart
  }, "*");
});

// ---------- Search ----------
document.getElementById("searchInput").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  renderTimeline(
    allPosts.filter(p =>
      p.text.toLowerCase().includes(q) ||
      p.author.toLowerCase().includes(q)
    )
  );
});

// ---------- Trending ----------
["#Shutdown","#Trump","#Kennedy","#ICE","#Congress"]
.forEach(tag => {
  const li = document.createElement("li");
  li.textContent = tag;

  li.onclick = () => {
    const query = tag.replace(/^#/, "").toLowerCase();
    searchInput.value = query;
    searchInput.dispatchEvent(new Event("input"));
  };

  trendingList.appendChild(li);
});


// ---------- Weather ----------
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
      .then(r => r.json())
      .then(d => {
        weather.innerHTML =
          `<strong>${Math.round(d.current_weather.temperature)}Â°C</strong><br>
           Wind ${d.current_weather.windspeed} km/h`;
      });
  });
}
</script>

</body>
</html>
